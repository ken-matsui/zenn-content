---
title: "Supabase ã§ Array ã® Join"
emoji: "ğŸ“š"
type: "tech"
topics: ["supabase", "postgresql"]
published: true
---

# ä½¿ã†ã‚‚ã®

* Supabase

https://supabase.com

* Supabase Database Functions

https://supabase.com/docs/guides/database/functions

# Foreign Key Array

ã¾ãšã€PostgreSQL ã¯ã€Foreign Key Array ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€Supabase ã‚‚å‹¿è«–å¯¾å¿œã—ã¦ã„ãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

https://github.com/supabase/supabase/discussions/535#discussioncomment-285696

ãã†ã„ã£ãŸç†ç”±ã‹ã‚‰ã€UUID ã® Array ã¨ã—ã¦æƒ…å ±ã‚’æŒã¤ã‚ˆã†ã«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã—ã¾ã™ã€‚
ä»Šå›ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

![Schema](/images/supabase-join-array/schema.png)
*Generated by [Supabase Schema](https://supabase-schema.vercel.app/)*

ä¸Šå›³ã§ã¯ã€`owners` ãŒå®Ÿè³ªçš„ãª Foreign Key Array ã¨ãªã‚Šã¾ã™ã€‚
ã‚«ãƒ©ãƒ åã‹ã‚‰åˆ†ã‹ã‚‹é€šã‚Šã€`users` ãƒ†ãƒ¼ãƒ–ãƒ«ã® ID ã‚’ UUID ã® Array ã¨ã—ã¦ä¿æŒã™ã‚‹ãŸã‚ã®ã‚«ãƒ©ãƒ ã«ãªã‚Šã¾ã™ã€‚

ã“ã†ã„ã£ãŸæ§‹æˆã®æ™‚ã€`owners` ã‚’ for æ–‡ã§å›ã—ã¦ã€`users` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ 1 ã¤ã¥ã¤å–å¾—ã—ã¦ã„ãã®ã¯éå¸¸ã«é…ã„å‡¦ç†ã¨ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã“ã§ã€[Supabase Database Functions](https://supabase.com/docs/guides/database/functions) ã‚’æ´»ç”¨ã—ã¦ã€Join ã—ãŸçŠ¶æ…‹ã‚’è¿”ã™ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

# ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹

ã¾ãšã€ä»Šå›ä½¿ç”¨ã™ã‚‹ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚
Supabase Dashboard ã‹ã‚‰ã€SQL Editor ã¸ç§»å‹•ã—ã¦ãã ã•ã„ã€‚
ãã—ã¦ã€ä»¥ä¸‹ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã€`RUN` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```sql
create table if not exists files (
    id uuid primary key default uuid_generate_v4(),
    owners uuid[]
);

create table if not exists users (
    id uuid primary key default uuid_generate_v4(),
    name text,
    email text not null
);

insert into files values
    ('3bab501e-99d6-43db-bc8d-bebe8af36cf9', '{"6f13b35e-a2c8-442f-95cb-c2ebf5dc5638", "71b4fee4-139a-44fe-98de-780064bea81e"}');

insert into users values
    ('6f13b35e-a2c8-442f-95cb-c2ebf5dc5638', 'Hoge', 'hoge@example.com'),
    ('71b4fee4-139a-44fe-98de-780064bea81e', 'Fuga', 'fuga@example.com');
```

`Success. No rows returned` ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ Table Editor ã«ç§»å‹•ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã«ã€ãã‚Œãã‚Œã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![Files Table](/images/supabase-join-array/files-table.png)
*files table*

![Users Table](/images/supabase-join-array/users-table.png)
*users table*

RLS ã¯ã‚„ã‚„ã“ã—ããªã£ã¦ã—ã¾ã†ãŸã‚ã€ä¸€æ—¦ã‚ªãƒ•ã®ã¾ã¾ã«ã—ã¦ã„ã¾ã™ã€‚
æœ¬ç•ªé‹ç”¨ã™ã‚‹å‰ã«ã¯ã€ã‚ªãƒ³ã«ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

`uuid_generate_v4()` ã¨ã„ã†ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ã“ã¡ã‚‰ã¯ã€`uuid-ossp` ã¨ã„ã† Extension ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ç‰¹ã«è¨­å®šã™ã‚‹ã“ã¨ãªãä½¿ç”¨ã§ãã¾ã™ã€‚

https://supabase.com/docs/guides/database/extensions/uuid-ossp#uuid_generate_v4

ä»–ã® Extensions ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ã€Supabase Dashboard > Database > Extensions ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

# Array ã®ä¸­èº«ã‚’ Join ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’æ›¸ã

ç¶šã„ã¦ã€å…ˆç¨‹ç”¨æ„ã—ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã€Array ã®ä¸­èº«ã‚’ Join ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã¾ãšã€Supabase Dashboard ã‹ã‚‰ SQL Editor ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã€`New query` ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„ã‚¯ã‚¨ãƒªã‚’ç”¨æ„ã—ã¾ã™ã€‚
ãã—ã¦ã€ä»¥ä¸‹ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã€`RUN` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

```sql
select * from files
left outer join lateral (
  select json_agg(files_attr) as owner_contents
  from (
    select *
    from unnest(owners) as arr(id)
    join users using(id)
  ) as files_attr
) as owner_contents on true;
```

> ä¸Šè¨˜ã®ã‚¯ã‚¨ãƒªã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

https://qiita.com/nishimura/items/575e642503139229059a

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã«ã€`owner_contents` ã‚«ãƒ©ãƒ ã®ä¸­ã«ã€Array ã®ä¸­èº«ãŒå±•é–‹ã•ã‚ŒãŸçŠ¶æ…‹ã§å…¥ã£ã¦ã„ã¾ã™ã€‚

![Join Result](/images/supabase-join-array/join-result.png)

# PostgreSQL Function ã¨ã—ã¦å®šç¾©ã™ã‚‹

ä»¥ä¸‹ã‚’ã€SQL Editor å†…ã«ãƒšãƒ¼ã‚¹ãƒˆã—ã€`RUN` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
`Success. No rows returned` ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°ã€é–¢æ•°ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```sql
create function get_files()
returns setof record
language sql
as $$
  select * from files
  left outer join lateral (
    select json_agg(files_attr) as owner_contents
    from (
      select *
      from unnest(owners) as arr(id)
      join users using(id)
    ) as files_attr
  ) as owner_contents on true;
$$;
```

ä¸Šæ‰‹ãã„ã£ã¦ã„ã‚Œã°ã€é–¢æ•°ã‚’å©ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```sql
select get_files();
```

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒè¿”ã£ã¦ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![Select get_files](/images/supabase-join-array/select-get-files.png)

å¤‰ãªå½¢å¼ã«å¤‰ã‚ã£ã¦ã¯ã„ã¾ã™ãŒã€ä¸€å¿œæ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã« Select ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```sql
select id from get_files();
```

```
a column definition list is required for functions returning "record"
```

ã¾ãŸã€supabase client ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ filter ã‚’æŒ‡å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

https://supabase.com/docs/reference/javascript/rpc#with-filters

ã“ã‚Œã¯ã€record ã ã¨è¿”ã‚Šå€¤å‹ã¨ã—ã¦ã¯ä¸å……åˆ†ã§ã€æ­£ã—ãæœ¬æ¥è¿”ã•ã‚Œã‚‹ã¯ãšã®å‹ã‚’ç¶²ç¾…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚
ã“ã‚Œã§ã¯ã‚ã¾ã‚Šä½¿ã„å¿ƒåœ°ãŒè‰¯ã„ã‚‚ã®ã§ã¯ãªã„ã®ã§ã€ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚

## è¿”ã‚Šå€¤å‹ã‚’æ˜è¨˜ã™ã‚‹

è¿”ã‚Šå€¤å‹ã‚’ç¶²ç¾…ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚
å…¨ã¦æ›¸ã„ã¦ã„ãã—ã‹ãªã„ãŸã‚ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¤šã„ãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆã¯ã€ã‹ãªã‚Šå¤§å¤‰ã‹ã¨æ€ã„ã¾ã™ã€‚

```sql
create or replace function get_files()
returns table (
  id uuid,
  owners uuid[],
  owner_contents json
)
language sql
as $$
  select
    files.id,
    files.owners,
    owner_contents
  from files
  left outer join lateral (
    select json_agg(files_attr) as owner_contents
    from (
      select *
      from unnest(owners) as arr(id)
      join users using(id)
    ) as files_attr
  ) as owner_contents on true;
$$;
```

ã“ã®ã¾ã¾ `RUN` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```
cannot change return type of existing function
```

ä¸€åº¦å®šç¾©ã—ãŸé–¢æ•°ã®è¿”ã‚Šå€¤å‹ã‚’ã€å¾Œã‹ã‚‰å¤‰æ›´ã§ããªã„ãŸã‚ã§ã™ã€‚
ãã®ãŸã‚ã€ä¸€æ—¦é–¢æ•°ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

SQL Editor çµŒç”±ã§é–¢æ•°ã‚’ä½œæˆã—ãŸå ´åˆã§ã‚‚ã€Supabase Dashboard > Database > Functions ã¨ç§»å‹•ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã« GUI ã¨ã—ã¦ç¢ºèªã§ãã¾ã™ã€‚
`Delete function` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

![Function List](/images/supabase-join-array/function-list.png)

SQL Editor ã¸æˆ»ã‚Šã€å…ˆç¨‹ã®ã‚¯ã‚¨ãƒªã‚’å†åº¦å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„ã€‚
ã™ã‚‹ã¨ã€`Success. No rows returned` ã¨è¡¨ç¤ºã•ã‚Œã€ä¸Šæ‰‹ãé–¢æ•°ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

`owner_contents` ã¯ Join ã—ãŸã‚«ãƒ©ãƒ ã«ãªã‚Šã¾ã™ãŒã€ã“ã¡ã‚‰ã®å‹ã‚’ `json` ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚
ã“ã¡ã‚‰ã‚’ã€`json[]` ã¨ã—ã¦å®šç¾©ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ä¸Šè¨˜é–¢æ•°ãŒä½œæˆã•ã‚ŒãŸä¸Šã§ã€ä¸‹è¨˜ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```sql
select id from get_files();
```

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã«ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãªã `id` ã®ã¿ãŒè¿”ã£ã¦ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![Select id from get_files](/images/supabase-join-array/select-id-get-files.png)

ã¾ãŸã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`setof record` ã¨ã—ã¦å®šç¾©ã—ã¦ã„ãŸé–¢æ•°ã¨ã¯ç•°ãªã‚Šã€ã‚­ãƒ¬ã‚¤ãªå½¢ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚

```sql
select * from get_files();
```

![Select all from get_files](/images/supabase-join-array/select-all-get-files.png)

# supabase client ã‹ã‚‰é–¢æ•°ã‚’å©ã

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€[rpc](https://supabase.com/docs/reference/javascript/rpc) ã‚’ç”¨ã„ã¦ Supabase Database Function ã‚’å©ãã¾ã™ã€‚

<!-- textlint-disable ja-technical-writing/ja-no-mixed-period -->
:::details FileType ã®å®šç¾©ä¾‹
<!-- textlint-enable -->
```ts
type UUID = string;

interface User {
    id: UUID;
    name?: string;
    email: string;
}

interface FileType {
    id: UUID;
    owners?: UUID[];
    owner_contents?: User[];
}
```
:::

```ts
const { data, error } = await supabaseClient
    .rpc<FileType>("get_files")
    .eq("id", "3bab501e-99d6-43db-bc8d-bebe8af36cf9")
    .limit(1)
    .single();

if (!error && data) {
    console.log(data);
}
```

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```json
{
    "id": "3bab501e-99d6-43db-bc8d-bebe8af36cf9",
    "owners": [
        "6f13b35e-a2c8-442f-95cb-c2ebf5dc5638",
        "71b4fee4-139a-44fe-98de-780064bea81e"
    ],
    "owner_contents": [
        {
            "id":"6f13b35e-a2c8-442f-95cb-c2ebf5dc5638",
            "name":"Fuga",
            "email":"fuga@example.com"
        },
        {
            "id":"71b4fee4-139a-44fe-98de-780064bea81e",
            "name":"Hoge",
            "email":"hoge@example.com"
        }
    ]
}
```

# æœ€å¾Œã«

ä»¥ä¸Šã§å®Œæˆã«ãªã‚Šã¾ã™ã€‚
ç„¡é§„ã« for æ–‡ã§å›ã™å¿…è¦ã‚‚ãªãã€ãã‚Œã§ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã‚‰ã‚Œã‚‹ãŸã‚ã€éå¸¸ã«ä¾¿åˆ©ãªé–¢æ•°ã«ä»•ä¸ŠãŒã£ãŸã¨æ€ã„ã¾ã™ã€‚

SQL ã® `create function` ã¯ã€è¿”ã‚Šå€¤å‹ãŒé–“é•ã£ã¦ã„ã‚‹ã“ã¨ã—ã‹æ•™ãˆã¦ãã‚Œãªã„ãŸã‚ã€è§£æ±ºã¾ã§ã‹ãªã‚Šå››è‹¦å…«è‹¦ã—ã¾ã—ãŸã€‚

Foreign Key Array ã‚’ä½¿ç”¨ã—ã‚ˆã†ã¨è€ƒãˆã‚‹å‰ã«ã€ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã®æ–¹ãŒãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã¯å¤šã„ã¨æ€ã„ã¾ã™ãŒã€å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
